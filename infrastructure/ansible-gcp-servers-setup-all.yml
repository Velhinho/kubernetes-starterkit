---
# file: ansible-gcp-servers-setup-all.yml
# configures the server instances
# This Playbook has Three Plays: one for critical configurations in all servers
# A second one for installing software in web servers
# a third one to install software in the bootstorage

# This First Play sets up critical configuration on servers
- hosts: targets
  # as the systems are not yet "known" by Ansible Facts cannot be gathered yet
  gather_facts: no
  remote_user: ubuntu
  become: yes
  become_method: sudo

  pre_tasks:
    # To operate remotely in critical files without direct user input
    - name: Remove require tty - alt
      lineinfile:
        regexp: "requiretty"
        dest: /etc/sudoers.d/os_defaults
        state: absent
    # Giving permissions in sudoers for system critical files (see https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html)
    - name: Validate the sudoers file before saving not to require password
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%ADMIN ALL='
        line: '%ADMIN ALL=(ALL) NOPASSWD: ALL'
        validate: /usr/sbin/visudo -cf %s
    # Install the SSH key on servers
    - name: install ssh key
      authorized_key:
        user: ubuntu
        key: "{{ lookup('file', '/home/vagrant/.ssh/id_rsa.pub') }}"
        state: present

  tasks:
    - name: apt update
      apt:
        name: "*"
        state: latest
        update_cache: yes

    - name: install git
      apt:
        pkg: git
        state: present

    - name: check if directory exists
      stat:
        path: "kubernetes-starterkit/"
      register: kube_dir

    - name: remove outdated repo folder
      ansible.builtin.file:
        path: /home/ubuntu/kubernetes-starterkit
        state: absent
      when: kube_dir.stat.exists

    - name: download repo
      ansible.builtin.git:
        repo: https://github.com/Velhinho/kubernetes-starterkit.git
        dest: /home/ubuntu/kubernetes-starterkit

    - name: daemon reload
      ansible.builtin.systemd:
        daemon_reload: yes


# populate the /etc/hosts
- hosts: targets
  gather_facts: True
  remote_user: ubuntu
  become: yes
  become_method: sudo

  tasks:
    - name: update /etc/hosts file for name resolution
      lineinfile:
        dest: /etc/hosts
        regexp: '.*{{ item }}$'
        line: "{{ hostvars[item].ansible_host }} {{item}}"
        state: present
      when: hostvars[item].ansible_host is defined
      with_items: '{{groups.targets}}'


#  web servers
- hosts: web
  gather_facts: True
  remote_user: ubuntu
  become: yes
  become_method: sudo

  tasks:    
    - name: install npm
      apt:
        pkg: npm
        state: present



# Vue Play
- hosts: vue
  gather_facts: True
  remote_user: ubuntu
  become: yes
  become_method: sudo

  tasks:
    - name: remove service file
      ansible.builtin.file:
        path: /etc/systemd/system/start-vue.service
        state: absent

    - name: copy start-vue.service to systemd
      ansible.builtin.copy:
        src: /home/ubuntu/kubernetes-starterkit/infrastructure/templates/start-vue.service
        dest: /etc/systemd/system/start-vue.service
        remote_src: yes
   
    - name: start vue
      ansible.builtin.systemd:
        state: restarted
        name: start-vue



# Happy Play
- hosts: happy
  gather_facts: True
  remote_user: ubuntu
  become: yes
  become_method: sudo

  tasks:   
    - name: remove service file
      ansible.builtin.file:
        path: /etc/systemd/system/start-happy.service
        state: absent

    - name: copy start-happy.service to systemd
      ansible.builtin.copy:
        src: /home/ubuntu/kubernetes-starterkit/infrastructure/templates/start-happy.service
        dest: /etc/systemd/system/start-happy.service
        remote_src: yes
   
    - name: start happy
      ansible.builtin.systemd:
        state: restarted
        name: start-happy


# Expressed Play
- hosts: expressed
  gather_facts: True
  remote_user: ubuntu
  become: yes
  become_method: sudo

  tasks:  
    - name: remove service file
      ansible.builtin.file:
        path: /etc/systemd/system/start-expressed.service
        state: absent

    - name: copy start-expressed.service to systemd
      ansible.builtin.copy:
        src: /home/ubuntu/kubernetes-starterkit/infrastructure/templates/start-expressed.service
        dest: /etc/systemd/system/start-expressed.service
        remote_src: yes
   
    - name: start expressed
      ansible.builtin.systemd:
        state: restarted
        name: start-expressed


# Bootstorage Play
- hosts: bootstorage
  gather_facts: true
  remote_user: ubuntu
  become: yes
  become_method: sudo

  tasks:
    - name: install python3
      apt:
        pkg: python3
        state: present

    - name: install flask
      apt:
        pkg: python3-flask
        state: present
      
#    - name: install flask
#      shell:
#        "sudo apt install python3-flask -y"
    
    - name: remove service file
      ansible.builtin.file:
        path: /etc/systemd/system/start-flask.service
        state: absent

    - name: copy start-flask.service to systemd
      ansible.builtin.copy:
        src: /home/ubuntu/kubernetes-starterkit/infrastructure/templates/start-flask.service
        dest: /etc/systemd/system/start-flask.service
        remote_src: yes
   
    - name: start flask
      ansible.builtin.systemd:
        state: restarted
        name: start-flask

